<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
	<meta name="description" content="Savers Savings Tracker"/>
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<title>Savers</title>
	<!-- icon -->
	<!--link rel="icon" href="img/mdb-favicon.ico" type="image/x-icon"-->
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
	<!-- Google Fonts -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
	<!-- Bootstrap core CSS -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
	<!-- Material Design Bootstrap -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" rel="stylesheet">
	<!-- Your custom styles (optional) -->
	<!--link rel="stylesheet" href="css/style.css"-->

	<!-- JQuery -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<!-- Bootstrap tooltips -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
	<!-- Bootstrap core JavaScript -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
	<!-- MDB core JavaScript -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js"></script>
    <script type="text/javascript">
let pos;
let map;
let bounds;
let infoWindow;
let currentInfoWindow;
let service;
let infoPane;
function initMap() {
    bounds = new google.maps.LatLngBounds();
    infoWindow = new google.maps.InfoWindow;
    currentInfoWindow = infoWindow;
    infoPane = document.getElementById('panel');

    if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(position => {
        pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };
        map = new google.maps.Map(document.getElementById('map'), {
            center: pos,
            zoom: 15
        });
        bounds.extend(pos);

        infoWindow.setPosition(pos);
        infoWindow.setContent('Location found.');
        infoWindow.open(map);
        map.setCenter(pos);
        getNearbyPlaces(pos);
    }, () => {
        handleLocationError(true, infoWindow);
    });
    } else {
        handleLocationError(false, infoWindow);
    }
}

function handleLocationError(browserHasGeolocation, infoWindow) {
        pos = {lat: -33.856, lng: 151.215};
        map = new google.maps.Map(document.getElementById('map'), {
        center: pos,
        zoom: 15
    });

    infoWindow.setPosition(pos);
    infoWindow.setContent(browserHasGeolocation ?
    'Geolocation permissions denied. Using default location.' :
    'Error: Your browser doesn\'t support geolocation.');
    infoWindow.open(map);
    currentInfoWindow = infoWindow;

    getNearbyPlaces(pos);
}
function getNearbyPlaces(position) {
    let request = {
        location: position,
        rankBy: google.maps.places.RankBy.DISTANCE,
        keyword: 'WalMart Target'
    };

    service = new google.maps.places.PlacesService(map);
    service.nearbySearch(request, nearbyCallback);
}

function nearbyCallback(results, status) {
    if (status == google.maps.places.PlacesServiceStatus.OK) {
      	createMarkers(results);
      	results.forEach(place => {
    	var paragraph = document.getElementById("list");
        	paragraph.innerHTML += place.name;
        	paragraph.innerHTML += "<br />"
      	})
    }
}

	function createMarkers(places) {
  	places.forEach(place => {
        let marker = new google.maps.Marker({
           	position: place.geometry.location,
            map: map,
            title: place.name
        });

        google.maps.event.addListener(marker, 'click', () => {
            let request = {
            placeId: place.place_id,
            fields: ['name', 'formatted_address', 'geometry', 'rating',
                'website', 'photos']
            };
            service.getDetails(request, (placeResult, status) => {
            showDetails(placeResult, marker, status)
            });
    	});

      	bounds.extend(place.geometry.location);
      	});
    map.fitBounds(bounds);
	}

function showDetails(placeResult, marker, status) {
    if (status == google.maps.places.PlacesServiceStatus.OK) {
     	let placeInfowindow = new google.maps.InfoWindow();
      	placeInfowindow.setContent('<div><strong>' + placeResult.name +
          	'</strong><br>' + 'Rating: ' + placeResult.rating + '</div>');
      	placeInfowindow.open(marker.map, marker);
      	currentInfoWindow.close();
      	currentInfoWindow = placeInfowindow;
      	showPanel(placeResult);
    } else {
      	console.log('showDetails failed: ' + status);
    }
}

let items_list;
let search_ind;
let alt_list;
function generate_searched(items) {
  document.getElementById("map").style.display="none";
  document.getElementById("alt_name").innerHTML="";
  results=document.getElementById('results');
  item_list=items;
  let n=items.length;
  let bt;
  let i;

  results.innerHTML='';

  for (i =0; i<n; ++i) {
    bt=document.createElement("button");
    bt.type="button";
    bt.setAttribute("onclick","select_search("+i+")");
    bt.setAttribute("class", "list-group-item list-group-item-action")
    bt.innerHTML = items[i].name+" $"+items[i].price;
    results.appendChild(bt);
  }
}
function show_alt(item_index) {
  item=item_list[item_index];
  search_ind=item_index;
  document.getElementById('results').innerHTML="";
  document.getElementById("alt_name").innerHTML="You chose "+item.name+" $"+item.price+", <br /> here are some alternatives:";
  document.getElementById("map").style.display="block";
  request_alternatives();
}

function show_confirm(item_index) {
  fin_item=alt_list[item_index];
  ori_item=item_list[search_ind];
  document.getElementById('alt_results').innerHTML="";
  document.getElementById('alt_name').innerHTML="";
  document.getElementById("confirm_mesg").innerHTML="You are purchasing "+fin_item.name+" $"+fin_item.price+" <br /> You haved saved $"+(ori_item.price-fin_item.price);
  confirm_purchase();
}

function generate_alt(items) {
  console.log(items);
  alt_list=items;
  results=document.getElementById('alt_results');
  let n=items.length;
  let bt;
  let i;

  results.innerHTML='';

  for (i =0; i<n; ++i) {
    bt=document.createElement("button");
    bt.type="button";
    bt.setAttribute("onclick","select_alternative("+items[i].barcode+","+i+")");
    bt.setAttribute("class", "list-group-item list-group-item-action")
    bt.innerHTML = items[i].name+" $"+items[i].price;
    results.appendChild(bt);
  }
}
async function init_search() {

      searched_item=document.getElementById("search_bar").value

      const response = await fetch("/search", {
        method: "POST",
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'item='+searched_item+'&lat=37.7510&lon=-97.8220'
      });
      generate_searched(await response.json());
  }

function select_search(item_index) {
    console.log(item_index);
    const response = fetch ("/select_item", {
      method: "POST",
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: 'item_number='+item_index
    });
    show_alt(item_index);
} 

async function request_alternatives() {
  const response = await fetch ("/alternatives", {
    method: "POST",
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: 'lat=37.7510&lon=-97.8220&CHEAPER=false&CLOSER=false&SAME=false'
  });
  generate_alt(await response.json());
}

function select_alternative(upc,item_index) {
    var xhttp = new XMLHttpRequest(); 
    xhttp.onreadystatechange = function() { 
      if (this.readyState == 4 && this.status == 200) { 
        var Data = JSON.parse(this.responseText);
        localStorage.setItem("final_selection", Data.message);
      }
    };
    xhttp.open("POST", "/select_purchase", true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.send('upc='+upc);
    show_confirm(item_index);
}

function confirm_purchase() {
    var xhttp = new XMLHttpRequest(); 
    xhttp.onreadystatechange = function() { 
      if (this.readyState == 4 && this.status == 200) { 
        alert("Success! Great job.")
      }
    };
    xhttp.open("POST", "/confirm", true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.send();
} 

	    $.get("/user", function(data) {
	        $("#user").html(data.name);
	        $(".unauthenticated").hide()
	        $(".authenticated").show()
	    });
	    var logout = function() {
		    $.post("/logout", function() {
		        $("#user").html('');
		        $(".unauthenticated").show();
		        $(".authenticated").hide();
		    })
		    return true;
		}
		$.get("/error", function(data) {
		    if (data) {
		        $(".error").html(data);
		    } else {
		        $(".error").html('');
		    }
		});
	</script>
	<script type="text/javascript" src="/webjars/js-cookie/js.cookie.js"></script>
	<script type="text/javascript">
		$.ajaxSetup({
		  beforeSend : function(xhr, settings) {
		    if (settings.type == 'POST' || settings.type == 'PUT'
		        || settings.type == 'DELETE') {
		      if (!(/^http:.*/.test(settings.url) || /^https:.*/
		        .test(settings.url))) {
		        xhr.setRequestHeader("X-XSRF-TOKEN",
		          Cookies.get('XSRF-TOKEN'));
		      }
		    }
		  }
		});
	</script>
	<!--script type="text/javascript" src="js/results.js"></script-->
	<!--script type="text/javascript" src="js/util.js"></script-->
	<style>
    #map {
      height: 500px;
	  width: 400px;
      background-color: grey;
	}
	h1 {
		margin-top: 7%;
	}
  </style>
</head>


<body>
	<div class="container">
		<h1>Savings Tracker</h1>
	</div>
	<div class="container unauthenticated">
	  <div>
	    With Github:  <a href="/oauth2/authorization/github">click here</a>
	  </div>
	</div>
	<div class="container authenticated" style="display:none">
	    Logged in as: <span id="user"></span>
	  <div>
	    <button onClick="logout()" class="btn btn-primary">Logout</button>
	  </div>
	</div>
	<div class="container text-danger error"></div>

	<div class="container">
		<div class="input-group md-form form-sm form-1 pl-0">
			<input class="form-control my-0 py-1" type="text" placeholder="Search"  id="search_bar">
			<div type="button" onclick="init_search()" class="input-group-prepend">
				<span class="input-group-text blue lighten-3" id="basic-text1"><i class="fas fa-search text-white"
					aria-hidden="true"></i></span>
			</div>
			
		</div>
	</div>
	<div class="container">
		<div id='results' class="list-group"></div>
	</div>

	<div class="container" id="alt_name"></div>
	<div class="container" id="confirm_mesg"></div>

	<div class="container" id="map" style="display:none">
		<script type="text/javascript" >

		</script>
		<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDPs4HhHB9JaJOfOAERq9sxdwZuxj6KbaM&libraries=places&callback=initMap">
		</script>
	</div>

	<div class="container">
		<div id='alt_results' class="list-group"></div>
	</div>
</body>
</html>
